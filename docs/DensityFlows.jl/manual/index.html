<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Manual · DensityFlows.jl</title><meta name="title" content="Manual · DensityFlows.jl"/><meta property="og:title" content="Manual · DensityFlows.jl"/><meta property="twitter:title" content="Manual · DensityFlows.jl"/><meta name="description" content="Documentation for DensityFlows.jl."/><meta property="og:description" content="Documentation for DensityFlows.jl."/><meta property="twitter:description" content="Documentation for DensityFlows.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">DensityFlows.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Overview</a></li><li><input class="collapse-toggle" id="menuitem-2" type="checkbox" checked/><label class="tocitem" for="menuitem-2"><span class="docs-label">Manual</span><i class="docs-chevron"></i></label><ul class="collapsed"><li class="is-active"><a class="tocitem" href>Manual</a><ul class="internal"><li><a class="tocitem" href="#Prepare-the-data"><span>Prepare the data</span></a></li><li><a class="tocitem" href="#Elementary-layers"><span>Elementary layers</span></a></li><li><a class="tocitem" href="#Blocks:-combination-of-layers"><span>Blocks: combination of layers</span></a></li><li><a class="tocitem" href="#More-about-the-layers"><span>More about the layers</span></a></li><li><a class="tocitem" href="#Train-the-model"><span>Train the model</span></a></li><li><a class="tocitem" href="#Save-and-load-the-model"><span>Save and load the model</span></a></li><li><a class="tocitem" href="#Use-the-model"><span>Use the model</span></a></li><li><a class="tocitem" href="#To-go-further:-define-custom-layers"><span>To go further: define custom layers</span></a></li></ul></li><li><a class="tocitem" href="../example/">Example</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3" type="checkbox"/><label class="tocitem" for="menuitem-3"><span class="docs-label">Public API</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../api_overview/">Overview</a></li><li><a class="tocitem" href="../api_coupling/">Couplings</a></li><li><a class="tocitem" href="../api_data/">Data</a></li><li><a class="tocitem" href="../api_flow/">Flow</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Manual</a></li><li class="is-active"><a href>Manual</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Manual</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/gaetanfacchinetti/DensityFlows.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/gaetanfacchinetti/DensityFlows.jl/blob/main/docs/src/manual.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Manual"><a class="docs-heading-anchor" href="#Manual">Manual</a><a id="Manual-1"></a><a class="docs-heading-anchor-permalink" href="#Manual" title="Permalink"></a></h1><p>Let us assume a <span>$d$</span>-dimensional dataset organised as an <code>Array{Float32}</code> called <code>x</code> such that <code>size(x, 1) = d</code>. Further assume n parameters / conditions gathered into a <code>Array{Float32}</code> called <code>θ</code> such that <code>size(θ, 1) = n</code>. To each <code>x</code> value should correspond one <code>θ</code> value, i.e <code>size(x)[2:end] == size(θ)[2:end]</code>. If these conditions are satisfied one can find the distribution of <span>$x$</span> knowing <span>$\theta$</span> from the following steps.</p><h2 id="Prepare-the-data"><a class="docs-heading-anchor" href="#Prepare-the-data">Prepare the data</a><a id="Prepare-the-data-1"></a><a class="docs-heading-anchor-permalink" href="#Prepare-the-data" title="Permalink"></a></h2><p>For convinivence the data can be stored in a <code>DataArrays</code> object as shown below. For the purpose of this quick start guide we use dummy normal distributed variables. See <a href="../example/">the example section</a> for a more realistic scenario. </p><pre><code class="language-julia hljs">using Flux
using Optimisers
using LinearAlgebra
using Distributions
using DensityFlows

x = randn(Float32, 7, 100)
θ = randn(Float32, 2, 100)

data = DataArrays(x, θ, f_training = 0.8, f_validation=0.2)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">DataArrays{Float32, 2, Matrix{Float32}, Matrix{Float32}, Vector{Int64}}(Float32[0.14612919 -0.84508497 … 0.6955385 0.18594217; 0.035727594 2.6930804 … 1.0583127 0.21927387; … ; -0.41413024 -1.5098333 … -1.6367465 -0.97976094; 0.6479841 0.11090934 … -1.3115077 -0.26058286], Float32[-1.4059678 0.23681319 … -0.24246544 -0.49308914; -0.0037724387 1.1567144 … 0.9686755 1.0763762], DataPartition{Vector{Int64}}([24, 89, 25, 68, 27, 95, 16, 77, 6, 46  …  91, 58, 86, 42, 48, 18, 82, 23, 72, 33], [21, 4, 13, 63, 99, 44, 51, 85, 12, 19, 49, 38, 35, 94, 80, 79, 3, 74, 2, 81], Int64[]))</code></pre><p>The sum of the training and validation fractions must be below or equal to 1. They are used to randomly partition the data before training.</p><h2 id="Elementary-layers"><a class="docs-heading-anchor" href="#Elementary-layers">Elementary layers</a><a id="Elementary-layers-1"></a><a class="docs-heading-anchor-permalink" href="#Elementary-layers" title="Permalink"></a></h2><p>The elementary elements of the flow are the <a href="../api_coupling/"><code>CouplingLayers</code></a>. A coupling layer is more particularly a bijective transformation which acts on some dimensions while leaving the others unchanged. In order to perform a transformation of all dimensions a chain of coupling layers is necessary. All definitions of coupling layer below are equivalent and transform dimensions 4, 5, 6, and 7.</p><pre><code class="language-julia hljs">CouplingLayer(data)
CouplingLayer(data, 3)
CouplingLayer(data, [4, 5, 6, 7])
CouplingLayer(7, [4, 5, 6, 7], n=2)
CouplingLayer(7, 3, n=2)</code></pre><p>and gives</p><pre><code class="language-julia hljs">@summary CouplingLayer(7, 3, n=2)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">RNVPCouplingLayer | s_net &gt; [5, 32, 32, 4] (1380 parameters)
                  | t_net &gt; [5, 32, 32, 4] (1380 parameters)
                  | axes  &gt; (d,n)=(7,2); identity=(1,2,3), transformed=(4,5,6,7)</code></pre><p>One can also use the <code>reverse</code> option to rather transform the dimensions 1, 2, and 3</p><pre><code class="language-julia hljs">CouplingLayer(data, reverse=true)
CouplingLayer(data, 3, reverse=true)
CouplingLayer(data, [1, 2, 3])
CouplingLayer(7, [1, 2, 3], n=2)
CouplingLayer(7, 3, n=2, reverse=true)</code></pre><p>in which case</p><pre><code class="language-julia hljs">@summary CouplingLayer(7, 3, n=2, reverse=true)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">RNVPCouplingLayer | s_net &gt; [6, 32, 32, 3] (1379 parameters)
                  | t_net &gt; [6, 32, 32, 3] (1379 parameters)
                  | axes  &gt; (d,n)=(7,2); identity=(4,5,6,7), transformed=(1,2,3)</code></pre><p>Layers can then be stacked in a <code>chain</code> to create a flow. An example would be</p><pre><code class="language-julia hljs">chain = FlowChain(
    CouplingLayer(data, [4, 5, 6, 7]),
    CouplingLayer(data, [2, 3, 4, 5]),
    CouplingLayer(data, [7, 1, 2, 3]),
    NormalizationLayer(x, -1f0, 1f0)
    )
@summary chain</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">RNVPCouplingLayer | s_net &gt; [5, 32, 32, 4] (1380 parameters)
                  | t_net &gt; [5, 32, 32, 4] (1380 parameters)
                  | axes  &gt; (d,n)=(7,2); identity=(1,2,3), transformed=(4,5,6,7)
RNVPCouplingLayer | s_net &gt; [5, 32, 32, 4] (1380 parameters)
                  | t_net &gt; [5, 32, 32, 4] (1380 parameters)
                  | axes  &gt; (d,n)=(7,2); identity=(1,6,7), transformed=(2,3,4,5)
RNVPCouplingLayer | s_net &gt; [5, 32, 32, 4] (1380 parameters)
                  | t_net &gt; [5, 32, 32, 4] (1380 parameters)
                  | axes  &gt; (d,n)=(7,2); identity=(4,5,6), transformed=(7,1,2,3)
Normalization Layer</code></pre><p>where good practice is to place a <code>NormalizationLayer</code> at the end to increase the performances of the network and avoid <code>NaN</code>s.</p><h2 id="Blocks:-combination-of-layers"><a class="docs-heading-anchor" href="#Blocks:-combination-of-layers">Blocks: combination of layers</a><a id="Blocks:-combination-of-layers-1"></a><a class="docs-heading-anchor-permalink" href="#Blocks:-combination-of-layers" title="Permalink"></a></h2><p>A <code>CouplingBlock</code> is a combination of two layers, with complentary transformations on axes. That is, if the first layer transforms dimensions 1, 3, 4, 7 the second transforms dimensions 2, 5, and 6 by construction. Said differently, the following chains are equivalent</p><pre><code class="language-julia hljs">chain = FlowChain(
    CouplingLayer(data, [4, 5, 6, 7]),
    CouplingLayer(data, [1, 2, 3]),
    )
@summary chain</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">RNVPCouplingLayer | s_net &gt; [5, 32, 32, 4] (1380 parameters)
                  | t_net &gt; [5, 32, 32, 4] (1380 parameters)
                  | axes  &gt; (d,n)=(7,2); identity=(1,2,3), transformed=(4,5,6,7)
RNVPCouplingLayer | s_net &gt; [6, 32, 32, 3] (1379 parameters)
                  | t_net &gt; [6, 32, 32, 3] (1379 parameters)
                  | axes  &gt; (d,n)=(7,2); identity=(4,5,6,7), transformed=(1,2,3)</code></pre><pre><code class="language-julia hljs">chain = FlowChain(
    CouplingBlock(data, [4, 5, 6, 7]),
    )
@summary chain</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">RNVPCouplingLayer | s_net &gt; [5, 32, 32, 4] (1380 parameters)
                  | t_net &gt; [5, 32, 32, 4] (1380 parameters)
                  | axes  &gt; (d,n)=(7,2); identity=(1,2,3), transformed=(4,5,6,7)
RNVPCouplingLayer | s_net &gt; [6, 32, 32, 3] (1379 parameters)
                  | t_net &gt; [6, 32, 32, 3] (1379 parameters)
                  | axes  &gt; (d,n)=(7,2); identity=(4,5,6,7), transformed=(1,2,3)</code></pre><h2 id="More-about-the-layers"><a class="docs-heading-anchor" href="#More-about-the-layers">More about the layers</a><a id="More-about-the-layers-1"></a><a class="docs-heading-anchor-permalink" href="#More-about-the-layers" title="Permalink"></a></h2><p>By default coupling layers are set as Real-NVP (ADD REFERENCE) which requires two neural networks called <code>s</code> for scaling and <code>t</code> for translation. Both of these networks are instances of <code>Flux.Dense</code> but their properties can also be modified from the <code>CouplingLayer</code>constructor. First, the following two declarations are equivalent.</p><pre><code class="language-julia hljs">@summary CouplingLayer(data)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">RNVPCouplingLayer | s_net &gt; [5, 32, 32, 4] (1380 parameters)
                  | t_net &gt; [5, 32, 32, 4] (1380 parameters)
                  | axes  &gt; (d,n)=(7,2); identity=(1,2,3), transformed=(4,5,6,7)</code></pre><pre><code class="language-julia hljs">@summary CouplingLayer(RNVPCouplingLayer, data)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">RNVPCouplingLayer | s_net &gt; [5, 32, 32, 4] (1380 parameters)
                  | t_net &gt; [5, 32, 32, 4] (1380 parameters)
                  | axes  &gt; (d,n)=(7,2); identity=(1,2,3), transformed=(4,5,6,7)</code></pre><p>Second, properties of the <code>s</code> and <code>t</code> network can be changed as follows.</p><pre><code class="language-julia hljs">@summary CouplingLayer(data, n_sublayers_s=3, n_sublayers_t=4, hidden_dim_s=16, hidden_dim_t=12, σ_s=Flux.relu, σ_t=Flux.sigmoid)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">RNVPCouplingLayer | s_net &gt; [5, 16, 16, 16, 4] (708 parameters)
                  | t_net &gt; [5, 12, 12, 12, 12, 4] (592 parameters)
                  | axes  &gt; (d,n)=(7,2); identity=(1,2,3), transformed=(4,5,6,7)</code></pre><p>Finally then can also be set direclty but one then needs to be carefull with the input and output dimensions. The input dimension should be <code>number of untransformed dimensions</code> + <span>$n$</span> and the output dimension should be <code>number of transformed dimensions</code>.</p><pre><code class="language-julia hljs">s_net = Flux.Chain([Flux.Dense(5, 32, Flux.sigmoid), Flux.Dense(32, 16, Flux.relu), Flux.Dense(16, 4)])
t_net = Flux.Chain([Flux.Dense(5, 12, Flux.relu), Flux.Dense(12, 16, Flux.logcosh), Flux.Dense(16, 32, Flux.relu), Flux.Dense(32, 4)])
@summary CouplingLayer(s_net, t_net, data)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">RNVPCouplingLayer | s_net &gt; [5, 32, 16, 4] (788 parameters)
                  | t_net &gt; [5, 12, 16, 32, 4] (956 parameters)
                  | axes  &gt; (d,n)=(7,2); identity=(1,2,3), transformed=(4,5,6,7)</code></pre><h2 id="Train-the-model"><a class="docs-heading-anchor" href="#Train-the-model">Train the model</a><a id="Train-the-model-1"></a><a class="docs-heading-anchor-permalink" href="#Train-the-model" title="Permalink"></a></h2><p>First define the flow from the a chain of layers and a base distribution. By default the latter is set to a multivariate Normal distribution but any distribution from the <code>Distributions</code> package can be used.</p><pre><code class="language-julia hljs">flow = Flow(chain, data)

# which is equivalent to
base = Distributions.MvNormal(zeros(Float32, 7), LinearAlgebra.diagm(ones(FLoat32, 7)))
flow = Flow(base, chain, data)</code></pre><p>Then, one needs to define the state of the model and the optimiser</p><pre><code class="language-julia hljs">state = Optimisers.setup(Optimisers.Adam(1f-3), flow.model)</code></pre><p>and then call the <code>train!</code> function</p><pre><code class="language-julia hljs">train!(flow, data, state, epochs=100, batchsize=64)</code></pre><h2 id="Save-and-load-the-model"><a class="docs-heading-anchor" href="#Save-and-load-the-model">Save and load the model</a><a id="Save-and-load-the-model-1"></a><a class="docs-heading-anchor-permalink" href="#Save-and-load-the-model" title="Permalink"></a></h2><p>After training the model can be saved using</p><pre><code class="language-julia hljs"># if directory &quot;my_flow&quot; does not already exists
@save_flow &quot;my_flow&quot; flow

# to overwrite any existing directory / model with the same name
@clear_and_save_flow &quot;my_flow&quot; flow </code></pre><p>and loaded back from</p><pre><code class="language-julia hljs">flow = @load_flow &quot;my_flow&quot;</code></pre><h2 id="Use-the-model"><a class="docs-heading-anchor" href="#Use-the-model">Use the model</a><a id="Use-the-model-1"></a><a class="docs-heading-anchor-permalink" href="#Use-the-model" title="Permalink"></a></h2><p>The model can be used to sample new data points or to extract the probability distribution function.</p><h2 id="To-go-further:-define-custom-layers"><a class="docs-heading-anchor" href="#To-go-further:-define-custom-layers">To go further: define custom layers</a><a id="To-go-further:-define-custom-layers-1"></a><a class="docs-heading-anchor-permalink" href="#To-go-further:-define-custom-layers" title="Permalink"></a></h2><p>The code has been built such that it is easy to implement new layers. It must take the form of a struct on which is applied the <code>Flux.@layer</code> macro specifying the trainable parameters. Then it must define a <code>forward</code> and <code>backward</code> functions that are differentiable by <code>Zygote</code> (or use a custom chain rule). These two functions must have signature <code>(::NewLayer, ::AbstractArray{T,N}, ::AbstractArray{T,N}) where {T,N}</code> and return the transformed array as well as the logarithm of the determinant of the jacobian of the transformation.</p><pre><code class="language-julia hljs">struct NewLayer{U, V} &lt;: FlowElement
    a::U
    b::V
end

# make the coupling layer parameters trainable
Flux.@layer NewLayer trainable=(a,)

# dummy forward and backward functions
forward(layer::NewLayer, z::AbstractArray{T,N}, θ::AbstractArray{T,N}) where {T,N} = a .* z .+ b, a
backward(layer::NewLayer, x::AbstractArray{T,N}, θ::AbstractArray{T,N}) where {T,N} = (x .- b) ./ a, one(T)/a</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">backward (generic function with 1 method)</code></pre><p>One must then also define a <code>forward!</code> function. One can define a custom one or use a macro to define a default. Similarly using another macro one can also define a functor in place of <code>forward(...)</code> to call <code>layer(...)</code> but this is optional.</p><pre><code class="language-julia hljs">@auto_forward! NewLayer
@auto_functor NewLayer</code></pre><p>By default such a structure is saved as two files, one for <code>a</code> and one for <code>b</code> if both are simple elements everything can be saved in a single file using the macro</p><pre><code class="language-julia hljs">@save_as_atomic NewLayer</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../">« Overview</a><a class="docs-footer-nextpage" href="../example/">Example »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.14.1 on <span class="colophon-date" title="Tuesday 4 November 2025 15:41">Tuesday 4 November 2025</span>. Using Julia version 1.11.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
